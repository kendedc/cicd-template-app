name: project-name

trigger:
  branches:
    include:
      - main
      - development
      - staging

resources:
  repositories:
    - repository: cicd-templates
      type: github
      name: kendedc/test-cicd-template
      ref: refs/heads/main
      endpoint: kendedc

parameters:
- name: azureSubscription
  type: string
  default: "sc-Ken-Test-Env-rg_de_core_dev_ea01"
- name: storageAccount
  type: string
  default: "cicdfrontendtest"
- name: nodeVersion
  type: string
  default: "20.x"

pool:
  vmImage: ubuntu-latest

stages:
- stage: Build
  displayName: "Build Stage"
  jobs:
  - job: InstallNode
    displayName: "Install Node Job"
    steps:
    - template: install-node.yml@cicd-templates
      parameters:
        nodeVersion: ${{ parameters.nodeVersion }}
  - job: Build
    displayName: "Build Job"
    dependsOn: InstallNode
    steps:
    - template: ci-steps.yml@cicd-templates

- stage: Deploy
  displayName: "Deploy Stage"
  dependsOn: Build
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
  jobs:
    - job: Deploy
      displayName: "Deploy Job"
      steps:
        - checkout: none
        - task: DownloadBuildArtifacts@1
          inputs:
            buildType: "current"
            downloadType: "single"
            artifactName: "$(Build.BuildId)-drop"
            downloadPath: "$(System.ArtifactsDirectory)"

        - script: |
            echo "PWD: $(pwd)"
            echo "Listing System.ArtifactsDirectory: $(System.ArtifactsDirectory)"
            ls -la "$(System.ArtifactsDirectory)" || true
            echo "Listing $(System.ArtifactsDirectory)/drop (if present)"
            ls -la "$(System.ArtifactsDirectory)/drop" || true
            echo "Listing $(System.ArtifactsDirectory)/drop/dist (if present)"
            ls -la "$(System.ArtifactsDirectory)/drop/dist" || true
            echo "Listing $(System.ArtifactsDirectory)/drop/build (if present)"
            ls -la "$(System.ArtifactsDirectory)/drop/build" || true
            echo "Listing $(System.ArtifactsDirectory)/$(Build.BuildId)-drop (if present)"
            ls -la "$(System.ArtifactsDirectory)/$(Build.BuildId)-drop" || true
            echo "Listing $(System.ArtifactsDirectory)/$(Build.BuildId)-drop/dist (if present)"
            ls -la "$(System.ArtifactsDirectory)/$(Build.BuildId)-drop/dist" || true
            echo "Listing $(System.ArtifactsDirectory)/$(Build.BuildId)-drop/build (if present)"
            ls -la "$(System.ArtifactsDirectory)/$(Build.BuildId)-drop/build" || true
          displayName: 'Debug: show downloaded artifact contents'

        - script: |
            echo "Will upload from: $(System.ArtifactsDirectory)/$(Build.BuildId)-drop"
            if [ ! -d "$(System.ArtifactsDirectory)/$(Build.BuildId)-drop" ]; then
              echo "ERROR: expected folder not found: $(System.ArtifactsDirectory)/$(Build.BuildId)-drop"
              ls -la "$(System.ArtifactsDirectory)" || true
              exit 1
            fi
          displayName: 'Verify artifact before upload'

        - task: AzureCLI@2
          inputs:
            azureSubscription: ${{ parameters.azureSubscription }}
            scriptType: "bash"
            scriptLocation: "inlineScript"
            inlineScript: |
              # debug: show folder before upload
              echo "Uploading from: $(System.ArtifactsDirectory)/$(Build.BuildId)-drop"
              ls -la "$(System.ArtifactsDirectory)/$(Build.BuildId)-drop" || true
              echo "Listing: $(System.ArtifactsDirectory)/$(Build.BuildId)-drop/dist"
              ls -la "$(System.ArtifactsDirectory)/$(Build.BuildId)-drop/dist" || true

              # If $web doesn't exist, enable static website (this will create $web)
              has_web=$(az storage container exists --name '$web' --account-name '${{ parameters.storageAccount }}' --auth-mode login --query "exists" -o tsv || echo "false")
              if [ "$has_web" != "true" ]; then
                echo "'\$web' container not found. Enabling static website (creates \$web)..."
                az storage blob service-properties update \
                  --account-name '${{ parameters.storageAccount }}' \
                  --static-website \
                  --index-document index.html \
                  --404-document 404.html \
                  --auth-mode login
                echo "Static website enabled (created \$web)."
              else
                echo "'\$web' container exists."
              fi

              # upload to the special static-website container named $web
              az storage blob upload-batch \
                --destination '$web' \
                --account-name '${{ parameters.storageAccount }}' \
                --account-key '$(TEMPLATE_APP_STORAGE_KEY)' \
                --source "$(System.ArtifactsDirectory)/$(Build.BuildId)-drop" \
                --overwrite
          displayName: "Deploy to Azure Storage"
